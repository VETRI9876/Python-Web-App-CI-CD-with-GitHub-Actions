name: Python Web App CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  # Job 1: Build Docker Image
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9

      - name: Install dependencies
        run: |
          pip install -r app/requirements.txt

      - name: Build Docker Image
        run: |
          docker build -t python-webapp:latest .

  # Job 2: Run Unit and Selenium Tests
  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9

      - name: Install dependencies
        run: |
          pip install -r app/requirements.txt

      - name: Install Google Chrome
        run: |
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Install ChromeDriver
        run: |
          sudo apt-get install -yqq unzip
          CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+')
          CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}" || curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE")
          wget -N https://chromedriver.storage.googleapis.com/${CHROMEDRIVER_VERSION}/chromedriver_linux64.zip
          unzip chromedriver_linux64.zip
          sudo mv chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver

      - name: Start Flask App in Background
        run: |
          python3 app/app.py &
          sleep 5

      - name: Run Selenium Test
        run: |
          python3 app/tests/test_app.py

  # Job 3: Simulate Packaging with JFrog
  package:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Simulate Package with JFrog
        run: |
          echo "Simulating packaging with JFrog."
          docker tag python-webapp:latest vetri20/python-webapp:latest
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push vetri20/python-webapp:latest
          echo "Package successfully pushed to Docker Hub."

  # Job 4: Deploy to Kubernetes
  deploy:
    needs: package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Apply Kubernetes Configurations
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

  # Job 5: Monitoring with Grafana & Prometheus
  monitor:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Start Docker Compose for Monitoring Stack
        run: |
          docker-compose up -d --build
          sleep 20  # Wait for Grafana and Prometheus to start

      - name: Verify App Metrics Endpoint
        run: curl http://localhost:5000/metrics

      - name: Verify Prometheus Target Status
        run: curl http://localhost:9090/targets

      - name: Check Grafana Status
        run: curl -I http://localhost:3000/login
